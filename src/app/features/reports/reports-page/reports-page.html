<div *ngIf="!canSeeReports()" style="padding:16px; opacity:.8;">
  No tienes permisos para ver reportes.
</div>

<div *ngIf="canSeeReports()" style="padding:16px; display:flex; flex-direction:column; gap:14px;">

  <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
    <h2 style="margin:0;">Reportes</h2>
    <button mat-stroked-button (click)="clearFilters()">Limpiar</button>
  </div>

  <mat-progress-bar *ngIf="loading" mode="indeterminate"></mat-progress-bar>

  <div *ngIf="error"
    style="background:#ffd9d9; border:1px solid rgba(0,0,0,.08); padding:10px 12px; border-radius:12px;">
    {{ error }}
  </div>

 

  <!-- Usuario picker -->
  <div style="display:flex; align-items:center; gap:12px; padding:12px; border:1px solid rgba(0,0,0,.1); border-radius:16px; background:white;">
    <div style="flex:1;">
      <div style="font-size:12px; opacity:.7;">Usuario (vendedor) opcional</div>

      <div style="font-weight:700;">
        {{ selectedUser?.name || '—' }}
        <span *ngIf="selectedUser" style="font-weight:400; opacity:.7; font-family:ui-monospace;">
          ({{ selectedUser?.id }})
        </span>
      </div>
    </div>

    <button mat-stroked-button (click)="openUserPicker($event)">Elegir usuario</button>
    <button mat-button *ngIf="selectedUser" (click)="clearSelectedUser()">Quitar</button>
  </div>

  <!-- Rango fechas para SUMMARY -->
  <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end;">
    <mat-form-field appearance="outline">
      <mat-label>Desde</mat-label>
      <input matInput [matDatepicker]="dpFrom" [(ngModel)]="from" (dateChange)="onRangeChanged()" />
      <mat-datepicker-toggle matSuffix [for]="dpFrom"></mat-datepicker-toggle>
      <mat-datepicker #dpFrom></mat-datepicker>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Hasta</mat-label>
      <input matInput [matDatepicker]="dpTo" [(ngModel)]="to" (dateChange)="onRangeChanged()" />
      <mat-datepicker-toggle matSuffix [for]="dpTo"></mat-datepicker-toggle>
      <mat-datepicker #dpTo></mat-datepicker>
    </mat-form-field>
  </div>

  <!-- Tarjetas SUMMARY -->
  <div *ngIf="summary as s" style="display:flex; flex-direction:column; gap:10px;">
    <mat-divider></mat-divider>

    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:12px;">

      <div style="border:1px solid rgba(0,0,0,.1); border-radius:16px; padding:12px 14px; background:white;">
        <div style="opacity:.7; font-size:12px;">Franquicia ID</div>
        <div style="font-family:ui-monospace; font-weight:800;">
          {{ s.franchiseId || '—' }}
        </div>
      </div>

      <div style="border:1px solid rgba(0,0,0,.1); border-radius:16px; padding:12px 14px; background:white;">
        <div style="opacity:.7; font-size:12px;">Desde</div>
        <div style="font-weight:800;">
          {{ s.from || '—' }}
        </div>
      </div>

      <div style="border:1px solid rgba(0,0,0,.1); border-radius:16px; padding:12px 14px; background:white;">
        <div style="opacity:.7; font-size:12px;">Hasta</div>
        <div style="font-weight:800;">
          {{ s.to || '—' }}
        </div>
      </div>

      <div style="border:1px solid rgba(0,0,0,.1); border-radius:16px; padding:12px 14px; background:white;">
        <div style="opacity:.7; font-size:12px;">sellerId (usuario)</div>
        <div style="font-weight:800;">
          {{ s.sellerId || '—' }}
        </div>
      </div>

      <div style="border:1px solid rgba(0,0,0,.1); border-radius:16px; padding:12px 14px; background:white;">
        <div style="opacity:.7; font-size:12px;">Número de ventas</div>
        <div style="font-size:22px; font-weight:900;">
          {{ s.salesCount || 0 }}
        </div>
      </div>

      <div style="border:1px solid rgba(0,0,0,.1); border-radius:16px; padding:12px 14px; background:white;">
        <div style="opacity:.7; font-size:12px;">Total vendido</div>
        <div style="font-size:22px; font-weight:900;">
          {{ money(s.totalSold || 0) }}
        </div>
      </div>

      <div style="border:1px solid rgba(0,0,0,.1); border-radius:16px; padding:12px 14px; background:white;">
        <div style="opacity:.7; font-size:12px;">Piezas vendidas</div>
        <div style="font-size:22px; font-weight:900;">
          {{ s.itemsQty || 0 }}
        </div>
      </div>

    </div>
  </div>

  <!-- Día para DAILY CLOSE -->
  <div style="display:flex; flex-direction:column; gap:10px;">
    <mat-divider></mat-divider>

    <mat-form-field appearance="outline" style="min-width:260px;">
      <mat-label>Día (para Daily Close)</mat-label>
      <input matInput [matDatepicker]="dpDayPick" [(ngModel)]="dayPick" (dateChange)="onDayChanged()" />
      <mat-datepicker-toggle matSuffix [for]="dpDayPick"></mat-datepicker-toggle>
      <mat-datepicker #dpDayPick></mat-datepicker>
    </mat-form-field>
  </div>

  <!-- Tarjetas DAILY CLOSE -->
  <div *ngIf="dailyClose as dc" style="display:flex; flex-direction:column; gap:10px;">
    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:12px;">

      <div style="border:1px solid rgba(0,0,0,.1); border-radius:16px; padding:12px 14px; background:white;">
        <div style="opacity:.7; font-size:12px;">Día</div>
        <div style="font-size:20px; font-weight:900;">
          {{ dc.day || '—' }}
        </div>
      </div>

      <div style="border:1px solid rgba(0,0,0,.1); border-radius:16px; padding:12px 14px; background:white;">
        <div style="opacity:.7; font-size:12px;">Ventas completadas</div>
        <div style="font-size:22px; font-weight:900;">
          {{ dc.salesCompleted || 0 }}
        </div>
      </div>

      <div style="border:1px solid rgba(0,0,0,.1); border-radius:16px; padding:12px 14px; background:white;">
        <div style="opacity:.7; font-size:12px;">Total vendido</div>
        <div style="font-size:22px; font-weight:900;">
          {{ money(dc.totalSold || 0) }}
        </div>
      </div>

      <div
        style="border:1px solid rgba(0,0,0,.1); border-radius:16px; padding:12px 14px; background:white; cursor:pointer;"
        (click)="openItemsModalDaily()"
        title="Ver desglose topProducts"
      >
        <div style="opacity:.7; font-size:12px;">Piezas vendidas (clic para desglose)</div>
        <div style="font-size:22px; font-weight:900;">
          {{ dc.itemsQty || 0 }}
        </div>
      </div>

      <div style="border:1px solid rgba(0,0,0,.1); border-radius:16px; padding:12px 14px; background:white;">
        <div style="opacity:.7; font-size:12px;">Cancelaciones</div>
        <div style="font-size:22px; font-weight:900;">
          {{ dc.cancelsCount || 0 }}
        </div>
      </div>

      <div style="border:1px solid rgba(0,0,0,.1); border-radius:16px; padding:12px 14px; background:white;">
        <div style="opacity:.7; font-size:12px;">Reembolsos</div>
        <div style="font-size:22px; font-weight:900;">
          {{ dc.refundsCount || 0 }}
        </div>
      </div>

      <div style="border:1px solid rgba(0,0,0,.1); border-radius:16px; padding:12px 14px; background:white;">
        <div style="opacity:.7; font-size:12px;">Total reembolsado</div>
        <div style="font-size:22px; font-weight:900;">
          {{ money(dc.refundsTotal || 0) }}
        </div>
      </div>

    </div>
  </div>

</div>

<!-- ========================= -->
<!-- MODAL: elegir usuario     -->
<!-- ========================= -->
<div *ngIf="userModalOpen"
  style="position:fixed; inset:0; background:rgba(0,0,0,.35); display:flex; align-items:center; justify-content:center; padding:16px; z-index:99999;"
  (click)="closeUserPicker()"
>
  <div
    style="background:white; width:min(720px, 100%); border-radius:16px; padding:16px; box-shadow:0 8px 30px rgba(0,0,0,.18);"
    (click)="$event.stopPropagation()"
  >
    <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
      <h3 style="margin:0;">Seleccionar usuario</h3>
      <div style="display:flex; gap:10px;">
        <button mat-stroked-button (click)="reloadUsers()">Recargar</button>
        <button mat-stroked-button (click)="closeUserPicker()">Cerrar</button>
      </div>
    </div>

    <mat-form-field appearance="outline" style="width:100%; margin-top:12px;">
      <mat-label>Buscar</mat-label>
      <input matInput [(ngModel)]="usersQuery" placeholder="Nombre, correo, rol..." />
    </mat-form-field>

    <div *ngIf="usersError"
      style="background:#ffd9d9; border:1px solid rgba(0,0,0,.08); padding:10px 12px; border-radius:12px; margin-top:10px;">
      {{ usersError }}
    </div>

    <div *ngIf="usersLoading" style="opacity:.7; margin-top:10px;">
      Cargando usuarios...
    </div>

    <div style="margin-top:12px; max-height:360px; overflow:auto; border:1px solid rgba(0,0,0,.08); border-radius:12px;">
      <div *ngIf="!usersLoading && usersFiltered.length === 0" style="padding:12px; opacity:.7;">
        No se encontraron usuarios.
      </div>

      <button
        *ngFor="let u of usersFiltered"
        type="button"
        (click)="pickUser(u)"
        style="width:100%; text-align:left; border:0; background:white; padding:12px 12px; cursor:pointer;
               display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid rgba(0,0,0,.06);"
      >
        <div>
          <div style="font-weight:800;">{{ u.name }}</div>
          <div style="font-size:12px; opacity:.7;">
            {{ u.email || '—' }} · {{ u.role || '—' }}
          </div>
        </div>
        <div style="font-family:ui-monospace; opacity:.7; font-size:12px;">
          {{ u.id }}
        </div>
      </button>
    </div>
  </div>
</div>

<!-- ========================= -->
<!-- MODAL: topProducts        -->
<!-- ========================= -->
<div *ngIf="itemsModalDaily"
  style="position:fixed; inset:0; background:rgba(0,0,0,.35); display:flex; align-items:center; justify-content:center; padding:16px; z-index:99999;"
  (click)="closeDailyItemsModal()"
>
  <div
    style="background:white; width:min(520px, 100%); border-radius:16px; padding:16px; box-shadow:0 8px 30px rgba(0,0,0,.18);"
    (click)="$event.stopPropagation()"
  >
    <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
      <h3 style="margin:0;">{{ itemsModalDaily.title }}</h3>
      <button mat-stroked-button (click)="closeDailyItemsModal()">Cerrar</button>
    </div>

    <div style="margin-top:12px; max-height:360px; overflow:auto;">
      <div *ngIf="itemsModalDaily.items.length === 0" style="opacity:.7;">
        No hay desglose para este día.
      </div>

      <div *ngFor="let it of itemsModalDaily.items"
        style="display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid rgba(0,0,0,.08);"
      >
        <div style="font-weight:700;">{{ it.name }}</div>
        <div style="font-family:ui-monospace; opacity:.85;">{{ it.qty }} pzs</div>
      </div>
    </div>
  </div>
</div>
